---
title: typed-es
description: D√©tecter les types de sorties de vos requ√™tes elasticsearch automatiquement.
datePublished: 2025-08-01
---

tldr: [https://github.com/Vahor/typed-es](https://github.com/Vahor/typed-es)

## Pourquoi cette librairie ?

Actuellement avec la librairie node elasticsearch, lorsqu'on fait une requ√™te search, on a des types de retour tr√®s minces.\
Les `_source{:ts}` sont de type `unknown{:ts}`. Il n'y a aucune s√©curit√© sur les champs ou non d'index.\
Le seul moyen d'ajouter quelques types est de tout d√©clarer manuellement.

```ts
const result = await client.search<
  { id: number; name: string },
  { categories: { buckets: Array<{ key: string; doc_count: number }> } }
>(query);
```

Mais rien n'assure que les types sont correctes ni √† jour par rapport √† la requ√™te..


## La solution

**typed-es** g√©n√®re automatiquement des types pr√©cis √† partir de la requ√™te Elasticsearch.

```ts
type Indexes = {
    products: {
        id: number;
        name: string;
        price: number;
        category: string;
        created_at: string;
    },
    users: {
        id: number;
        first_name: string;
        last_name: string;
        email: string;
    }
};

const query = typedEs(client, {
    index: "products",
    _source: ["*_at", "price"],
    track_total_hits: true,
    rest_total_hits_as_int: true,
    aggs: {
        categories: { terms: { field: "category" } }
    }
});

const result = await client.search(query);
const total = result.hits.total; // number
const firstHit = result.hits.hits[0]._source; // { price: number; created_at: string }
const categories = result.aggregations.categories.buckets;  // Array<{ key: unknown; doc_count: number; }>
```

üéâ Types parfaitement inf√©r√©s, sans d√©claration manuelle

### Fonctionnalit√©s

#### Auto-completion

Comme les types sont automatiquement g√©n√©r√©s, ils sont aussi utilis√©s pour l'auto-compl√©tion.

```typescript
const query = typedEs(client, {
    index: "p", // Ici l'IDE sugg√®re "products"
    _source: ["p"] // Une fois l'index d√©fini sur "products", l'IDE sugg√®re "price"
});
```

Note: Il est tout de m√™me possible d'acceder √† un champ qui n'existe pas directement dans la d√©finition de l'index, exemple "name.keyword" sera accept√©.

#### Types de sortie bas√©s sur les champs demand√©s

D√©rive des types exacts √† partir des configurations `_source`, `fields`, `docvalue_fields` et `aggregations`.

```typescript
const query = typedEs(client, {
    index: "users",
    _source: ["first_name", "email"],
    fields: [{ field: "created_at", format: "yyyy-MM-dd" }]
});

const result = await client.search(query);
const firstHit = result.hits.hits[0];
// Type pr√©cis : { 
//   _source: { first_name: string; email: string }, 
//   fields: { created_at: string[] } 
// }
```

#### Support des wildcards

D√©tecte et inf√®re correctement les types de sortie m√™me lors de l'utilisation de wildcards dans `_source`, `fields` et `docvalue_fields`.

```typescript
type ProductIndex = {
    products: {
        created_at: string;
        updated_at: string;
        title: string;
    }
};

const query = typedEs(client, {
    index: "products",
    _source: ["*_at"] // Wildcard
});

const result = await client.search(query);
const firstHit = result.hits.hits[0]._source;
// Type pr√©cis : { created_at: string; updated_at: string }
```

#### S√©curit√© des types de sortie

Si l'index est modifi√©, qu'un champ est supprim√© ou que le type change, une erreur de type sera d√©tect√©e.

#### Les options de requ√™tes influencent les types de sortie

```ts
const query = typedEs(client, {
    index: "products",
    _source: false,
    fields: ["name"],
    track_total_hits: true,
    rest_total_hits_as_int: true
});

const result = await client.search(query);
const total = result.hits.total; // type: number, au lieu de number | estypes.SearchTotalHits | undefined
const firstHit = result.hits.hits[0];
const firstHitSource = firstHit._source; // type: never, comme `_source` est d√©fini sur `false` il n'y aura jamais de `_source` dans la r√©ponse
const firstHitFields = firstHit.fields; // type: { name: string[] }
```

Note: si `track_total_hits` √©tait √† `false{:ts}`, `hits.total{:ts}` serait de type `never{:ts}`
