---
title: Rehype D2 Plugin
description: Un plugin Rehype pour convertir des diagrammes D2 en SVG ou PNG.
datePublished: 2025-03-29
---

tldr: [https://github.com/Vahor/rehype-d2](https://github.com/Vahor/rehype-d2)

## Comment je fais mes sch√©mas?

Avant D2, j'utilisais [excalidraw](https://excalidraw.com/) pour faire mes sch√©mas.

![Diagramme UML fait avec excalidraw](../../public/projects/rehype-d2/uml_diagram_in_editor_excalidraw.svg)
[source](https://plus.excalidraw.com/use-cases/uml-diagram)

Mais de plus en plus j'ai cherch√© √† faire des diagrammes en exprimant les concepts directement dans le texte. Pour √ßa j'ai commenc√© √† utiliser [eraser.io](https://eraser.io)

![Sch√©ma d'architecture fait avec eraser.io](../../public/projects/rehype-d2/diagram_eraser_io.svg)

Ici tout ce sch√©ma a √©t√© g√©n√©r√© √† partir de cette expression:

```bash
API gateway [icon: aws-api-gateway]
Lambda [icon: aws-lambda]
S3 [icon: aws-simple-storage-service]
VPC Subnet [icon: aws-vpc]{
  Main Server {
    Server [icon: aws-ec2]
    Data [icon: aws-rds]
  }
  Queue [icon: aws-auto-scaling]
  Compute Nodes [color: red] {
    Worker1 [icon: aws-ec2]
    Worker2 [icon: aws-ec2]
    Worker3 [icon: aws-ec2]
  }
}
Analytics [icon: aws-redshift]

// Define connections
API gateway > Lambda > Server > Data
Server > Queue > Worker1, Worker2, Worker3
S3 < Data
Compute Nodes > Analytics
```

Ce texte est simple a lire et est beaucoup plus simple a sauvegarder dans git ou a modifier.\
En comparaison, un export excalidraw est un fichier json qui contient les positions et propri√©t√©s de chaque √©l√©ment. Quasiment impossible a modifier manuellement.

Le soucis avec eraser.io est que c'est un outil payant... et qu'en version gratuite la customisation ou partage des sch√©mas est limit√©e.\
Un autre soucis _(qu'on avait aussi avec excalidraw)_ est qu'a chaque modification il faut aller sur le site pour re-g√©n√©rer un sch√©ma.

Du coup j'ai cherch√© un autre outil qui pourrait r√©pondre √† tous ces probl√®mes.

# Qu'est-ce que D2?

<UrlPreview url="https://d2lang.com/"/>

D2 est un outil de cr√©ation de diagrammes comparable √† mermaid, graphviz, plantuml, etc. [comparaison](https://text-to-diagram.com/)\
Avec un sytaxe plus simple, mais avec des fonctionnalit√©s avanc√©es.

Un point int√©ressant de D2 est l'utilisation de classes pour styliser des elements. Et la possibilit√© d'importer des fichiers pour les r√©-utiliser.

# Pourquoi il faut un plugin?

Il existe d√©j√† un plugin pour remark [remark-d2](https://github.com/mech-a/remark-d2), mais il n'est pas √† jour depuis 2 ans et manque des fonctionnalit√©s tel que les imports et la gestion d'un theme clair/sombre.

Du coup j'ai cr√©√© mon propre plugin.

<br/>
<small>
Note: Entre temps un autre plugin [rehype-d2](https://github.com/stereobooster/beoe/tree/main/packages/rehype-d2) a √©t√© cr√©√©, cependant il ne supporte pas l'utilisation d'imports diff√©rents selon le theme et le format de sorti ne me convient pas
</small>

# Comment √ßa marche?

<UrlPreview url="https://github.com/Vahor/rehype-d2"/>

Comme j'utilise [contentlayer](https://www.contentlayer.dev/) pour g√©rer mon contenu, je vais vous montrer comment l'utiliser avec contentlayer.

```bash
bun add -D @vahor/rehype-d2
```

```js title="contentlayer.config.ts"
import rehypeD2 from "@vahor/rehype-d2";
import { makeSource } from "contentlayer2/source-files";

...

export default makeSource({
    contentDirPath: contentFolder,
    documentTypes: [Post],
    mdx: {
        rehypePlugins: [[
            rehypeD2,
            {
                cwd: "public/blog/d2",
                defaultMetadata: {
                    sketch: false,
                },
            },
        ]],
    },
});
```

`@terrastruct/d2` utilises des imports dynamiques de wasm et js, ce qui pose soucis avec `contentlayer` [issue](https://github.com/timlrx/contentlayer2/issues/70). 
Pour √©viter cela il faut modifier les options esbuild du plugin:

```js title="next.config.ts"
import { createContentlayerPlugin, defaultPluginOptions } from "next-contentlayer2";
import type { NextConfig } from "next";

const nextConfig: NextConfig = {...}

const withContentlayer = createContentlayerPlugin({
	...defaultPluginOptions,
	esbuildOptions: {
		external: ["@terrastruct/d2"],
	},
});
module.exports = withContentlayer(nextConfig);
```

## Utilisation

ContentLayer se charge de convertir les fichiers mdx en HTML.\
Il nous suffit donc de sp√©cifier un bloc de code `d2` comme ceci:

~~~mdx
```d2 height=350 pad=20
a: From
b: To
a -> b: Arrow
```
~~~

Pour obtenir:

<div className="flex items-center justify-center">
```d2 height=350 pad=20
a: From
b: To
a -> b: Arrow
```
</div>

Si on y ajoute un plugin pour importer des fichiers, on peut obtenir:

~~~mdx
```d2 pad=10
@include "raw:../../../public/blog/d2/computer.d2"
```
~~~

ce qui donne:

```d2 pad=10
@include "raw:../../../public/blog/d2/computer.d2"
```

Magie! ü§Ø


Un petit dernier parce que c'est cool:

```d2 pad=40
@include "raw:../../../public/blog/d2/eraser.d2"
```

√áa vous dit quelque chose ? En utilisant du style on peut se rapprocher du style de eraser.io.

Il reste quelques issues √† corriger pour devenir un outil parfait, mais c'est un tr√®s bon d√©but.
- Theme global non appliqu√© [#2472](https://github.com/terrastruct/d2/issues/2472)
- Taille des √©lements de grid incorrect [#2471](https://github.com/terrastruct/d2/issues/2471)
- Am√©liorations des options de styles pour le label [#2446](https://github.com/terrastruct/d2/issues/2446)
- Soucis d'int√©gration avec contentlayer [#70](https://github.com/timlrx/contentlayer2/issues/70)

Source des diagrammes:
- [computer.d2](/blog/d2/computer.d2)
- [eraser.d2](/blog/d2/eraser.d2)
