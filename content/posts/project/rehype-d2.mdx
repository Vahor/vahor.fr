---
title: Rehype D2 Plugin
description: Un plugin Rehype pour convertir des diagrammes D2 en SVG ou PNG.
datePublished: 2025-03-29
---

# Qu'est-ce que D2?

<UrlPreview url="https://d2lang.com/"/>

## Cool diagrams

### Excalidraw
### Eraser.io

# Pourquoi il faut un plugin?

- Current remark plugin is not up to date (2 years old)
   - don't support imports


# Comment Ã§a marche?

<UrlPreview url="https://github.com/Vahor/rehype-d2"/>

## Setup

Comme j'utilise [contentlayer](https://www.contentlayer.dev/) pour gÃ©rer mon contenu, je vais vous montrer comment l'utiliser avec contentlayer.

```bash
bun add -D @vahor/rehype-d2
```

```js title="contentlayer.config.ts"
import rehypeD2 from "@vahor/rehype-d2";
import { makeSource } from "contentlayer2/source-files";

...

export default makeSource({
    contentDirPath: contentFolder,
    documentTypes: [Post],
    mdx: {
        rehypePlugins: [[
            rehypeD2,
            {
                cwd: "public/blog/d2",
                defaultMetadata: {
                    sketch: false,
                },
            },
        ]],
    },
});
```

`@terrastruct/d2` utilises des imports dynamiques de wasm et js, ce qui pose soucis avec `contentlayer` [issue](https://github.com/timlrx/contentlayer2/issues/70). 
Pour Ã©viter cela il faut modifier les options esbuild du plugin:

```js title="next.config.ts"
import { createContentlayerPlugin, defaultPluginOptions } from "next-contentlayer2";
import type { NextConfig } from "next";

const nextConfig: NextConfig = {...}

const withContentlayer = createContentlayerPlugin({
	...defaultPluginOptions,
	esbuildOptions: {
		external: ["@terrastruct/d2"],
	},
});
module.exports = withContentlayer(nextConfig);
```

## Use

ContentLayer se charge de convertir les fichiers mdx en HTML.\
Il nous suffit donc de spÃ©cifier un bloc de code `d2` comme ceci:

~~~mdx
```d2 height=350 pad=20
a: From
b: To
a -> b: Arrow
```
~~~

Pour obtenir:

<div className="flex items-center justify-center">
```d2 height=350 pad=20
a: From
b: To
a -> b: Arrow
```
</div>

Si on y ajoute un plugin pour importer des fichiers, on peut obtenir:

~~~mdx
```d2 pad=10
@include "raw:../../../public/blog/d2/computer.d2"
```
~~~

ce qui donne:

```d2 pad=10
@include "raw:../../../public/blog/d2/computer.d2"
```

Magic! ðŸ¤¯


Un petit dernier parce que c'est cool:

<div className="lg:-mx-20">
```d2 pad=40
@include "raw:../../../public/blog/d2/eraser.d2"
```
</div>

Source des diagrammes:
- [computer.d2](/blog/d2/computer.d2)
- [eraser.d2](/blog/d2/eraser.d2)
